import openai
import json
import time

# 设置OpenAI API密钥
openai.api_key = ''  # 替换为你的API密钥

# 定义系统提示，设置角色和评价标准
system_prompt = """
你是一个公正的评判者，熟悉心理知识，熟悉心理咨询。
你负责评估心理咨询师对来访者心理问题的回答质量，你的评价应该完全依据以下评价标准。

评价标准
1. 实际问题导向（总分：2分）
1.1 咨询师是否准确识别并聚焦来访者的主要问题？
评分标准：

1分：咨询师能够识别并明确指出来访者的主要问题。
0.5分：咨询师部分识别问题，但未完全聚焦。
0分：未能准确识别来访者的主要问题。
1.2 对话内容是否紧扣来访者的现实困境，避免偏离主题？
评分标准：

1分：对话内容始终围绕来访者的实际问题展开。
0.5分：对话中有部分内容偏离主题。
0分：对话内容频繁偏离来访者的现实困境。
2. 具体行动方案（总分：2分）
2.1 行动方案是否具体、明确，包含可执行的步骤？
评分标准：

1分：提供了清晰、具体且可操作的行动步骤。
0.5分：行动方案较为模糊，缺乏具体步骤。
0分：未提供明确的行动方案。
2.2 行动方案是否考虑到来访者的实际情况和资源？
评分标准：

1分：行动方案充分考虑了来访者的个人情况和可利用资源。
0.5分：部分考虑了来访者的实际情况和资源。
0分：行动方案忽视了来访者的实际情况和资源。
3. 交流互动（总分：2分）
3.1 咨询师是否积极引导对话，促进来访者表达？
评分标准：

1分：咨询师主动引导，鼓励来访者充分表达。
0.5分：咨询师在引导上有所不足，来访者表达受限。
0分：咨询师未能有效引导，限制了来访者的表达。
3.2 咨询师是否有效回应来访者的反馈，保持互动的流畅性？
评分标准：

1分：咨询师对来访者的反馈做出及时且有效的回应，互动自然流畅。
0.5分：回应部分有效，但互动不够流畅。
0分：回应无效，互动显得僵硬或断裂。
4. 共情与情感支持（总分：3分）
4.1 咨询师是否表现出对来访者情感的理解和认可？
评分标准：

1分：咨询师明确表达了对来访者情感的理解和认可。
0.5分：咨询师在理解和认可情感上表现有限。
0分：缺乏对来访者情感的理解和认可。
4.2 咨询师是否通过语言和态度传达支持和鼓励？
评分标准：

1分：通过适当的语言和积极的态度传达了充分的支持和鼓励。
0.5分：支持和鼓励的表达不够充分或不够恰当。
0分：缺乏支持和鼓励的表达。
4.3 咨询师是否在适当的时候提供情感上的安慰和支持？
评分标准：

1分：在关键时刻提供了及时且适当的情感安慰和支持。
0.5分：情感支持的时机或方式有待改进。
0分：未能在需要的时候提供情感支持。

约束
避免立场偏见，确保回答的顺序不会影响你的决策。
不要让回答的长度影响你的评价。
不要偏袒某几个助手的名字，尽量做到客观。
工作流程
严格按照“[A]：[评分]; [简短分析]”，“[B]：[评分]; [简短分析]”的格式输出你的最终判定。
同时展示每个小部分的分。
深呼吸，一步步思考！
"""

# 定义函数来格式化对话
def format_conversation(conversation):
    formatted = ""
    for turn in conversation:
        formatted += f"来访者：{turn['input']}\n咨询师：{turn['output']}\n"
    return formatted

# 定义函数来评估单个对话
def evaluate_conversation(conversation):
    prompt = f"""
以下是一段心理咨询对话，请根据指定的评价标准进行评估。请严格按照“[A]：[评分]; [简短分析]”，“[B]：[评分]; [简短分析]”的格式输出你的最终判定。

{format_conversation(conversation)}
"""
    try:
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": prompt}
            ],
            temperature=0  # 设置温度为0以获得更确定的输出
        )
        return response['choices'][0]['message']['content'].strip()
    except openai.error.OpenAIError as e:
        print(f"API请求失败: {e}")
        return None

def main():
    # 加载数据集
    with open('dataset.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    # 遍历每个对话进行评估
    for idx, item in enumerate(data):
        print(f"正在评估第 {idx + 1} 个对话...")
        evaluation = evaluate_conversation(item['conversation'])
        if evaluation:
            print(f"评估结果:\n{evaluation}\n")
        else:
            print("评估失败，跳过该对话。\n")
        # 为了避免达到API速率限制，可以添加延时
        time.sleep(1)  # 暂停1秒

if __name__ == "__main__":
    main()
